@using System.Linq
@using Team.Backend.Models.ViewModels
@using Team.Backend.Models.EfModel
@model NotificationManagementViewModel

@{
    ViewData["Title"] = "通知管理系統";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" crossorigin="anonymous" />
    <link href="~/css/notification-styles.css" rel="stylesheet" />
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- 主要管理卡片 -->
            <div class="card shadow mb-4">

                <!-- 卡片標題與主要操作區 -->
                <div class="card-header py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="bi bi-bell-fill mr-2"></i>通知管理系統
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end align-items-center">

                                <!-- 新增通知按鈕 -->
                                <button id="addNotificationBtn" class="btn btn-success btn-sm">
                                    <i class="bi bi-plus-circle"></i> 新增通知
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 工具列區域 -->
                <div class="card-body pb-2">
                    <div class="row g-3 mb-3">
                        <!-- 搜尋區塊 -->
                        <div class="col-md-6">
                            <div class="integrated-search-container">
                                <div class="integrated-search-bar">
                                    <input id="searchInput" type="text" class="search-input-integrated"
                                           placeholder="搜尋通知內容、郵件地址、分類..." />
                                    <button id="clearSearch" class="clear-search-btn" style="display: none;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <div class="search-actions">
                                        <button class="filter-btn-integrated" type="button" data-toggle="collapse" data-target="#filterPanel">
                                            <i class="bi bi-funnel"></i>
                                            <span class="btn-text">篩選</span>
                                        </button>
                                        <button id="searchBtn" class="search-btn-integrated">
                                            <i class="bi bi-search"></i>
                                            <span class="btn-text">搜尋</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 操作工具區塊 -->
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end align-items-center flex-wrap" style="gap: 0.5rem;">
                                <!-- 批量操作按鈕 -->
                                <div id="deleteSelectedBtn" style="display: none;">
                                    <!-- 內容將由 JavaScript 動態生成 -->
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- 篩選面板 -->
                    <div class="collapse" id="filterPanel">
                        <div class="card bg-light border-0 mb-3">
                            <div class="card-body">
                                <form method="get">
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label for="categoryFilter" class="form-label">
                                                分類
                                            </label>
                                            <select id="categoryFilter" name="category" class="form-select form-select-sm">
                                                <option value="">全部分類</option>
                                                <option value="order">訂單</option>
                                                <option value="payment">付款</option>
                                                <option value="account">帳戶</option>
                                                <option value="security">安全</option>
                                                <option value="promotion">促銷</option>
                                                <option value="system">系統</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="statusFilter" class="form-label">
                                                狀態
                                            </label>
                                            <select id="statusFilter" name="status" class="form-select form-select-sm">
                                                <option value="">全部狀態</option>
                                                <option value="immediate">立即發送</option>
                                                <option value="scheduled">排程</option>
                                                <option value="draft">草稿</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="channelFilter" class="form-label">
                                                管道
                                            </label>
                                            <select id="channelFilter" name="channel" class="form-select form-select-sm">
                                                <option value="">全部管道</option>
                                                <option value="email">電子郵件</option>
                                                <option value="push">內部推播</option>
                                            </select>
                                        </div>

                                        <!-- 日期範圍篩選組件 -->
                                        <div class="col-md-3">
                                            <label class="form-label">
                                                日期範圍
                                            </label>
                                            
                                                <div class="row g-2">
                                                    <div class="col-6">
                                                        <div class="input-group input-group-sm">
                                                            <input type="date" id="startDateFilter" name="startDate"
                                                                   class="form-control"
                                                                   placeholder="開始"
                                                                   title="選擇開始日期" />
                                                        </div>
                                                        <div class="form-text">開始日期</div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="input-group input-group-sm">
                                                            <input type="date" id="endDateFilter" name="endDate"
                                                                   class="form-control"
                                                                   placeholder="結束"
                                                                   title="選擇結束日期" />
                                                        </div>
                                                        <div class="form-text">結束日期</div>
                                                    </div>
                                                </div>
                                            
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <!-- ?? 移除 onclick，改用 data-action 屬性 -->
                                            <button type="button" class="btn btn-outline-secondary btn-sm" data-action="clear-filters">
                                                <i class="bi bi-arrow-clockwise"></i> 清除篩選
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 資料表格區域 -->
                <div class="card-body pt-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:40px">
                                        <input type="checkbox" id="selectAll" class="form-check-input" />
                                    </th>
                                    <th data-column="sentat" class="sortable" style="cursor: pointer; min-width: 140px;">
                                        發送時間 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="emailaddress" class="sortable" style="cursor: pointer; min-width: 180px;">
                                        收件人 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="category" class="sortable" style="cursor: pointer; width: 100px;">
                                        分類 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="emailstatus" class="sortable" style="cursor: pointer; width: 100px;">
                                        郵件狀態 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="channel" class="sortable" style="cursor: pointer; width: 100px;">
                                        管道 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="message" class="sortable" style="cursor: pointer;">
                                        訊息內容 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th style="width: 200px; text-align: center;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- 美化的初始載入狀態 -->
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="initial-loading">
                                            <div class="pulse-loader">
                                                <div class="pulse-dot"></div>
                                                <div class="pulse-dot"></div>
                                                <div class="pulse-dot"></div>
                                            </div>
                                            <div class="mt-3">
                                                <i class="bi bi-database me-2 text-primary"></i>
                                                正在載入通知資料...
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分頁資訊與控制 -->
                    <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center" style="gap: 1rem;">
                            <span class="text-muted" id="pageInfo">載入中...</span>
                        </div>
                        <nav aria-label="分頁導航">
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- 分頁將由 JavaScript 動態生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 編輯/新增通知模態框 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="bi bi-plus-circle mr-2"></i>新增通知
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="關閉">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <form id="notificationForm">
                    <input type="hidden" id="editId" name="id" />

                    <!-- 基本資訊區塊 -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="editCategory" class="form-label">
                                分類 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="editCategory" name="category" required>
                                <option value="">請選擇分類</option>
                                <option value="order">訂單</option>
                                <option value="payment">付款</option>
                                <option value="account">帳戶</option>
                                <option value="security">安全</option>
                                <option value="promotion">促銷</option>
                                <option value="system">系統</option>
                                <option value="restock">補貨</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="editChannel" class="form-label">
                                通知管道 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="editChannel" name="channel" required>
                                <option value="email">電子郵件</option>
                                <option value="push">推播</option>

                            </select>
                        </div>
                    </div>

                    <!-- 發送對象設定 -->
                    <div class="card bg-light border-0 mb-4">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="card-title">
                                <i class="bi bi-people me-1"></i>發送對象設定
                            </h6>
                        </div>
                        <div class="card-body pt-3">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="targetType"
                                               id="targetAllUsers" value="1" checked>
                                        <label class="form-check-label" for="targetAllUsers">
                                            全部會員（含廠商）
                                        </label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="targetType"
                                               id="targetVendors" value="2">
                                        <label class="form-check-label" for="targetVendors">
                                            全部廠商
                                        </label>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="radio" name="targetType"
                                               id="targetSpecific" value="3">
                                        <label class="form-check-label" for="targetSpecific">
                                            指定帳號
                                        </label>
                                    </div>

                                    <!-- 指定帳號輸入框 - 修正版本 -->
                                    <div id="specificAccountContainer" style="display: none;">
                                        <label class="form-label">選擇或輸入郵件地址</label>
                                        <select id="specificAccountSelect" class="form-select form-select-sm mb-2">
                                            <option value="">請選擇會員郵件</option>
                                            <option value="__custom__">輸入自訂Email</option>
                                        </select>
                                        <input type="email" class="form-control" id="specificAccount"
                                               name="specificAccount" placeholder="請輸入郵件地址 (例如: user@example.com)"
                                               disabled>
                                        <div class="form-text">您可以從下拉選單選擇現有會員Email，或選擇「輸入自訂Email」後手動輸入</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 狀態與時間設定 -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <label for="editEmailStatus" class="form-label">
                                郵件狀態 <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="editEmailStatus" name="emailStatus" required>
                                <option value="draft">草稿</option>
                                <option value="immediate">立即發送</option>
                                <option value="scheduled">排程</option>
                            </select>
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    草稿：暫存不發送 | 立即發送：儲存後立即發送 | 排程：設定未來時間發送
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- 排程時間設定 -->
                    <div id="scheduledDateContainer" style="display: none;" class="mb-4">
                        <label for="editScheduledAt" class="form-label">
                            排程時間 <span class="text-danger">*</span>
                        </label>
                        <input type="datetime-local" class="form-control" id="editScheduledAt" name="scheduledAt" />
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>請選擇要發送通知的時間（必須是未來時間）
                            </small>
                        </div>
                        <div class="form-text text-danger" id="scheduledDateError" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-1"></i>排程時間不能是過去時間
                        </div>
                    </div>

                    <!-- 隱藏的發送時間欄位（由系統自動設定） -->
                    <input type="hidden" id="editSentAt" name="sentAt" />

                    <!-- 訊息內容 -->
                    <div class="mb-3">
                        <label for="editMessage" class="form-label">
                            訊息內容 <span class="text-danger">*</span>
                            <button type="button" id="generateAiBtn" class="btn btn-outline-primary btn-sm" title="使用 OpenAI 生成文案">
                                <i class="bi bi-magic"></i> 重新生成
                            </button>
                        </label>
                        <div class="d-flex align-items-start" style="gap:0.5rem;">
                            <textarea class="form-control" id="editMessage" name="message" rows="4" required
                                      maxlength="2000" placeholder="請輸入通知訊息內容..."></textarea>
                            <div class="d-flex flex-column" style="gap:0.5rem;">
                                
                                <div id="aiGenerateSpinner" style="display:none; margin-top:4px; text-align:center;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small class="text-muted" id="messageCharCount">0/2000</small>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer" style="gap: 0.5rem;">
                <button type="button" class="btn btn-secondary" id="cancelBtn">
                    <i class="bi bi-x-circle mr-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="saveBtn">
                    <i class="bi bi-check-circle mr-1"></i>儲存
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- 載入主要通知管理模組 -->
    <script src="~/js/notification-management.js"></script>
 
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MainNotification 頁面腳本初始化');

            // Bootstrap 4 初始化
            if (typeof jQuery !== 'undefined' && jQuery.fn.dropdown) {
                $('.dropdown-toggle').dropdown();
                $('.collapse').collapse({
                    toggle: false
                });
            }

            // 篩選按鈕事件
            const filterBtn = document.querySelector('.filter-btn-integrated');
            if (filterBtn) {
                filterBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const filterPanel = document.getElementById('filterPanel');
                    if (filterPanel) {
                        $(filterPanel).collapse('toggle');
                    }
                });
            }

            // ?? 新增：清除篩選按鈕事件（統一處理）
            document.addEventListener('click', function(e) {
                if (e.target.closest('[data-action="clear-filters"]')) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.NotificationManager && typeof NotificationManager.clearFilters === 'function') {
                        NotificationManager.clearFilters();
                    }
                }
            });

            // 模態框關閉按鈕
            document.querySelectorAll('[data-dismiss="modal"]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const modal = this.closest('.modal');
                    if (modal && typeof jQuery !== 'undefined' && jQuery.fn.modal) {
                        $(modal).modal('hide');
                    }
                });
            });

            // Cancel 按鈕事件
            const cancelBtn = document.getElementById('cancelBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('editModal');
                    if (modal && typeof jQuery !== 'undefined' && jQuery.fn.modal) {
                        $(modal).modal('hide');
                    }
                });
            }

            // 排程時間設定
            const scheduledInput = document.getElementById('editScheduledAt');
            if (scheduledInput) {
                const now = new Date();
                const fiveMinutesLater = new Date(now.getTime() + 5 * 60000);
                const localDateTime = new Date(fiveMinutesLater.getTime() - fiveMinutesLater.getTimezoneOffset() * 60000)
                    .toISOString().slice(0, 16);
                scheduledInput.min = localDateTime;
            }

            console.log('MainNotification 頁面初始化完成');
        });
    </script>
}