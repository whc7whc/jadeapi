@using System.Linq
@using Team.Backend.Models.ViewModels
@using Team.Backend.Models.EfModel
@model NotificationManagementViewModel

@{
    ViewData["Title"] = "通知統計報表";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" crossorigin="anonymous" />
    <link href="~/css/notification-styles.css" rel="stylesheet" />
    @* <link href="~/css/notification-custom.css" rel="stylesheet" />
    <link href="~/css/notification-fix.css" rel="stylesheet" /> *@
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- 主要管理卡片 -->
            <div class="card shadow mb-4">
                <!-- 卡片標題與主要操作區 -->
                <div class="card-header py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="bi bi-bar-chart-fill me-2"></i>通知統計報表
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end align-items-center">
                                <!-- 匯出報表按鈕 -->
                                <button type="button" class="btn btn-outline-primary export-trigger-btn" id="exportStatsBtn">
                                    <i class="bi bi-download me-1"></i>匯出報表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 統計載入指示器 -->
                <div id="statsLoading" class="text-center py-4">
                    <div class="stats-loading">
                        <div class="stats-spinner">
                            <i class="bi bi-pie-chart rotating"></i>
                        </div>
                        <div class="mt-3">正在生成統計報表...</div>
                    </div>
                </div>

                <div class="card-body" id="statsContent" style="display: none;">
                    <!-- 統計卡片組 -->
                    <div class="col-md-12">
                        <div class="row">
                            <!-- 總通知數卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-envelope-fill text-primary"></i>
                                        <span>總通知數</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-primary" id="totalCount">0</div>
                                        <div class="stats-label">累計發送</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 已送達數卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        <span>已送達數</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-success" id="deliveredCount">0</div>
                                        <div class="stats-label">成功發送</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 失敗數卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-exclamation-triangle-fill text-danger"></i>
                                        <span>失敗數</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-danger" id="failedCount">0</div>
                                        <div class="stats-label">發送失敗</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 今日通知數卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-calendar-check-fill text-info"></i>
                                        <span>今日通知數</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-info" id="todayCount">0</div>
                                        <div class="stats-label">今日發送</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 排程數卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-clock-fill text-warning"></i>
                                        <span>排程數</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-warning" id="scheduledCount">0</div>
                                        <div class="stats-label">等待發送</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 成功率卡片 -->
                            <div class="col-md-4 mb-4">
                                <div class="stats-card">
                                    <div class="stats-card-header">
                                        <i class="bi bi-graph-up-arrow text-primary"></i>
                                        <span>成功率</span>
                                    </div>
                                    <div class="stats-card-body">
                                        <div class="stats-number text-primary" id="successRate">0%</div>
                                        <div class="stats-label">發送成功率</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 分類統計表格 -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-tag me-2"></i>分類統計</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>分類</th>
                                                    <th class="text-end">數量</th>
                                                    <th class="text-end">佔比</th>
                                                </tr>
                                            </thead>
                                            <tbody id="categoryStatsTableBody">
                                                <!-- 由JavaScript動態填充 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 狀態統計表格 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-activity me-2"></i>狀態統計</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>狀態</th>
                                                    <th class="text-end">數量</th>
                                                    <th class="text-end">佔比</th>
                                                </tr>
                                            </thead>
                                            <tbody id="statusStatsTableBody">
                                                <!-- 由JavaScript動態填充 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 管道統計表格 -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="bi bi-broadcast me-2"></i>管道統計</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>管道</th>
                                                    <th class="text-end">數量</th>
                                                    <th class="text-end">佔比</th>
                                                </tr>
                                            </thead>
                                            <tbody id="channelStatsTableBody">
                                                <!-- 由JavaScript動態填充 -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 圖表區域 -->
                        <div class="col-12 mt-4">
                            <div class="chart-container">
                                <div class="chart-header">
                                    <h6 class="chart-title">
                                        <i class="bi bi-pie-chart me-2"></i>通知分類統計
                                    </h6>
                                    <div class="chart-controls" style="gap: 0.5rem;">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="refreshChart()">
                                            <i class="bi bi-arrow-clockwise"></i> 重新整理
                                        </button>
                                    </div>
                                </div>
                                <div class="chart-body">
                                    <canvas id="statsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>