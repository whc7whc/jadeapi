@using Team.Backend.Models.ViewModels
@model CouponManagementViewModel

@{
    ViewData["Title"] = "優惠券管理系統";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <h5 class="mb-0">優惠券管理系統</h5>
                    <div class="d-flex align-items-center flex-wrap">
                        <button id="deleteSelectedBtn" class="btn btn-danger mr-2 mb-2" style="display:none;">
                            <i class="bi bi-trash"></i> 刪除選取項目
                        </button>

                        <button id="addCouponBtn" class="btn btn-success mr-2 mb-2">
                            <i class="bi bi-plus-circle"></i> 新增優惠券
                        </button>

                        <div class="integrated-search-container mr-2 mb-2">
                            <div class="integrated-search-bar">
                                <input id="searchInput" type="text" class="search-input-integrated" placeholder="搜尋優惠券名稱、類型..." />
                                <button id="clearSearch" class="clear-search-btn">
                                    <i class="bi bi-x"></i>
                                </button>
                                <div class="search-actions">
                                    <button class="filter-btn-integrated" type="button" data-toggle="collapse" data-target="#filterPanel">
                                        <i class="bi bi-funnel"></i>
                                        <span class="btn-text"></span>
                                        <span id="filterBadge" class="filter-badge-integrated">@Model.FilterCount</span>
                                    </button>
                                    <button id="searchBtn" class="search-btn-integrated">
                                        <i class="bi bi-search"></i>
                                        <span class="btn-text"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="dropdown mr-2 mb-2">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="itemsPerPageDropdown" data-toggle="dropdown">
                                <i class="bi bi-list-ol mr-2"></i>每頁 @Model.ItemsPerPage 筆
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-items="10">每頁 10 筆</a></li>
                                <li><a class="dropdown-item" href="#" data-items="20">每頁 20 筆</a></li>
                                <li><a class="dropdown-item" href="#" data-items="50">每頁 50 筆</a></li>
                            </ul>
                        </div>

                        <button id="statsBtn" class="btn btn-info mr-2 mb-2">
                            <i class="bi bi-bar-chart"></i> 統計
                        </button>
                    </div>
                </div>

                <div class="collapse" id="filterPanel">
                    <div class="card-body border-top">
                        <form method="get">
                            <div class="form-row">
                                <div class="col-md-3">
                                    <label for="typeFilter" class="form-label">優惠類型</label>
                                    <select id="typeFilter" name="type" class="form-control">
                                        <option value="">全部類型</option>
                                        @foreach (var type in Model.CouponTypes)
                                        {
                                            <option value="@type" selected="@(Model.SelectedType == type)">@type</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="statusFilter" class="form-label">狀態</label>
                                    <select id="statusFilter" name="status" class="form-control">
                                        <option value="">全部狀態</option>
                                        @foreach (var status in Model.CouponStatuses)
                                        {
                                            <option value="@status" selected="@(Model.SelectedStatus == status)">@status</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="dateFromFilter" class="form-label">開始日期</label>
                                    <input type="date" id="dateFromFilter" name="dateFrom" class="form-control" value="@Model.DateFrom?.ToString("yyyy-MM-dd")" />
                                </div>
                                <div class="col-md-3">
                                    <label for="dateToFilter" class="form-label">結束日期</label>
                                    <input type="date" id="dateToFilter" name="dateTo" class="form-control" value="@Model.DateTo?.ToString("yyyy-MM-dd")" />
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary mr-2">
                                        <i class="bi bi-funnel"></i> 套用篩選
                                    </button>
                                    <a href="@Url.Action("CouponsManager")" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-clockwise"></i> 清除篩選
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card-body">
                    <div id="loadingIndicator" class="text-center py-4" style="display:none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">載入中...</span>
                        </div>
                        <div class="mt-2">載入中...</div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped align-middle mb-0">
                            <thead>
                                <tr>
                                    <th style="width:32px"><input type="checkbox" id="selectAll" /></th>
                                    <th data-column="title" class="sortable" style="cursor:pointer;">優惠券名稱 <i class="bi bi-arrow-down-up"></i></th>
                                    <th data-column="discounttype" class="sortable" style="cursor:pointer;">優惠類型 <i class="bi bi-arrow-down-up"></i></th>
                                    <th data-column="discountamount" class="sortable" style="cursor:pointer;">折扣內容 <i class="bi bi-arrow-down-up"></i></th>
                                    <th>最低消費</th>
                                    <!-- 單一欄位，點擊以上限排序；按住 Shift 點擊以已用次數排序 -->
                                    <th data-column="usage" class="sortable" style="cursor:pointer;" title="點擊：按使用上限排序；Shift+點擊：按已用次數排序">
                                        使用/上限 <i class="bi bi-arrow-down-up"></i>
                                    </th>
                                    <th data-column="startat" class="sortable" style="cursor:pointer;">開始時間 <i class="bi bi-arrow-down-up"></i></th>
                                    <th data-column="expiredat" class="sortable" style="cursor:pointer;">有效期間 <i class="bi bi-arrow-down-up"></i></th>
                                    <th>狀態</th>
                                    <th style="width:200px">操作</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- 資料由 JavaScript 動態載入 -->
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="text-muted" id="pageInfo">載入中...</span>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- 分頁由 JavaScript 動態生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 編輯優惠券（Bootstrap 4 樣式） -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true" data-backdrop="static" data-keyboard="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">新增優惠券</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="關閉">
                    <span aria-hidden="true">×</span>
                </button>
            </div>

            <div class="modal-body">
                <form id="couponForm">
                    <input type="hidden" id="editId" name="id" />

                    <div class="mb-3">
                        <label for="editTitle" class="form-label">優惠券名稱</label>
                        <input type="text" class="form-control" id="editTitle" name="title" required maxlength="100" />
                        <small class="form-text text-muted">請輸入優惠券名稱，最多100字元</small>
                    </div>

                    <div class="mb-3">
                        <label for="editDiscountType" class="form-label">優惠類型</label>
                        <select class="form-control" id="editDiscountType" name="discountType" required>
                            <option value="">請選擇優惠類型</option>
                            <option value="%數折扣">%數折扣</option>
                            <option value="J幣回饋">J幣回饋</option>
                            <option value="滿減">滿減</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editDiscountAmount" class="form-label">折扣金額/比例</label>
                            <input type="number" class="form-control" id="editDiscountAmount" name="discountAmount" required min="1" step="1" />
                            <small class="form-text text-muted" id="discountAmountHint">請輸入折扣金額或比例</small>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editMinSpend" class="form-label">最低消費金額</label>
                            <input type="number" class="form-control" id="editMinSpend" name="minSpend" min="0" step="1" />
                            <small class="form-text text-muted">選填，設定使用此優惠券的最低消費門檻</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editUsageLimit" class="form-label">使用上限</label>
                            <input type="number" class="form-control" id="editUsageLimit" name="usageLimit" min="1" step="1" />
                            <small class="form-text text-muted">選填，不設定則無使用次數限制</small>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editUsedCount" class="form-label">已用次數</label>
                            <input type="number" class="form-control" id="editUsedCount" name="usedCount" readonly />
                            <small class="form-text text-muted">系統自動計算，不可編輯</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editStartAt" class="form-label">開始時間</label>
                            <input type="datetime-local" class="form-control" id="editStartAt" name="startAt" required />
                        </div>
                        <div class="form-group col-md-6">
                            <label for="editExpiredAt" class="form-label">結束時間</label>
                            <input type="datetime-local" class="form-control" id="editExpiredAt" name="expiredAt" required />
                            <small class="form-text text-danger" id="dateRangeError" style="display:none;">結束時間必須大於開始時間</small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="editApplicableLevelId" class="form-label">適用會員等級</label>
                            <select class="form-control" id="editApplicableLevelId" name="applicableLevelId">
                                <option value="">全部等級</option>
                                <option value="1">銅牌會員</option>
                                <option value="2">銀牌會員</option>
                                <option value="3">金牌會員</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="cancelBtn">取消</button>
                <button type="button" class="btn btn-primary" id="saveBtn">儲存</button>
            </div>
        </div>
    </div>
</div>

<!-- 統計模態框（BS4） -->
<div class="modal fade" id="statsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">優惠券統計</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="關閉">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row" id="statsContent">
                    <!-- 載入提示 -->
                    <div class="col-12 text-center" id="statsLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">載入中...</span>
                        </div>
                        <p class="mt-2">正在載入統計資料...</p>
                    </div>
                    
                    <!-- 統計內容 (初始隱藏) -->
                    <div class="col-md-3 d-none" id="statsCard1">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title">總優惠券數</h6>
                                <h3 class="text-primary" id="totalCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-none" id="statsCard2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title">進行中</h6>
                                <h3 class="text-success" id="activeCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-none" id="statsCard3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title">已過期</h6>
                                <h3 class="text-danger" id="expiredCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-none" id="statsCard4">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="card-title">未開始</h6>
                                <h3 class="text-warning" id="notStartedCount">0</h3>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 圖表區域 -->
                    <div class="col-12 mt-3 d-none" id="statsChart-container">
                        <h5 class="text-center mb-3">類型分布</h5>
                        <div style="max-width: 400px; margin: 0 auto;">
                            <canvas id="statsChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- 來源統計 -->
                    <div class="col-md-6 mt-3 d-none" id="sourceStatsCard">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">來源統計</h6>
                                <div class="row">
                                    <div class="col-6 text-center">
                                        <small class="text-muted">平台優惠券</small>
                                        <h4 class="text-primary" id="platformCount">0</h4>
                                    </div>
                                    <div class="col-6 text-center">
                                        <small class="text-muted">廠商優惠券</small>
                                        <h4 class="text-warning" id="vendorCount">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 錯誤訊息 -->
                    <div class="col-12 d-none" id="statsError">
                        <div class="alert alert-danger text-center">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span id="statsErrorMessage">載入統計資料失敗</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="~/css/coupon-styles.css" rel="stylesheet" />
}

@section Scripts {
    <script src="~/js/coupon-management.js"></script>
}



@functions {
    string GetTypeDisplayName(string type)
    {
        return type switch
        {
            "%數折扣" => "%數折扣",
            "J幣回饋" => "J幣回饋",
            "滿減" => "滿減",
            // 兼容舊資料
            "點數返還" => "J幣回饋",
            "折扣碼" => "%數折扣",
            "免運費" => "滿減",
            _ => type
        };
    }

    string GetStatusDisplayName(string status)
    {
        return status switch
        {
            "啟用" => "啟用",
            "已過期" => "已過期",
            "未開始" => "未開始",
            _ => status
        };
    }

    string GetTypeBadgeClass(string type)
    {
        return GetTypeDisplayName(type) switch
        {
            "%數折扣" => "success",
            "J幣回饋" => "primary",
            "滿減" => "warning",
            _ => "secondary"
        };
    }

    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "啟用" => "success",
            "已過期" => "danger",
            "未開始" => "warning",
            _ => "secondary"
        };
    }
}