# 🚚 **綠界物流整合測試指南**

## 📋 **測試前準備**

### **1. 執行物流商資料 SQL**
```sql
-- 在 SQL Server 中執行
INSERT INTO Carriers (Name, Contact, CreatedAt) VALUES
('黑貓宅急便', '客服專線: 0800-200-777', GETDATE()),
('7-11 超商取貨', '客服專線: 0800-008-711', GETDATE()),
('全家便利商店', '客服專線: 0800-030-588', GETDATE());
```

### **2. 啟動 Team.API**
```bash
cd Team.API
dotnet run
```

---

## 🧪 **綠界物流配送選項測試**

### **測試案例 1：基本物流選項**

#### **API 端點**
```http
GET https://localhost:7106/api/Checkout/delivery-methods/1
```

#### **預期結果（從資料庫讀取）**
```json
{
  "success": true,
  "data": [
    {
      "method": "HOME_TCAT",
      "name": "黑貓宅急便",
      "fee": 65,
      "description": "黑貓宅急便到府配送 - 1-2個工作天",
      "isAvailable": true,
      "estimatedDays": 2
    },
    {
      "method": "UNIMART",
      "name": "7-ELEVEN 超商取貨",
      "fee": 60,
      "description": "7-ELEVEN 超商取貨付款 - 2-4個工作天",
      "isAvailable": true,
      "estimatedDays": 3
    },
    {
      "method": "FAMI",
      "name": "全家便利商店取貨",
      "fee": 60,
      "description": "全家便利商店取貨付款 - 2-4個工作天",
      "isAvailable": true,
      "estimatedDays": 3
    }
  ]
}
```

### **驗證重點**
- ✅ **真實資料**：配送選項來自資料庫 Carriers 表
- ✅ **綠界代碼**：Method 欄位使用綠界物流 API 代碼
- ✅ **運費正確**：黑貓65元，超商60元

---

### **測試案例 2：金牌會員優惠**

#### **前置條件**
```sql
-- 設定測試會員為金牌會員
UPDATE Members 
SET MembershipLevelId = (SELECT Id FROM MembershipLevels WHERE LevelName = '金牌會員')
WHERE Id = 1;
```

#### **API 端點**
```http
GET https://localhost:7106/api/Checkout/delivery-methods/1
```

#### **預期結果**
```json
{
  "success": true,
  "data": [
    {
      "method": "HOME_TCAT",
      "name": "黑貓宅急便",
      "fee": 45,  // ← 原65元，金牌會員折20元
      "description": "黑貓宅急便到府配送 - 1-2個工作天 (金牌會員優惠)",
      "isAvailable": true,
      "estimatedDays": 2
    },
    {
      "method": "UNIMART",
      "name": "7-ELEVEN 超商取貨",
      "fee": 40,  // ← 原60元，金牌會員折20元
      "description": "7-ELEVEN 超商取貨付款 - 2-4個工作天 (金牌會員優惠)",
      "isAvailable": true,
      "estimatedDays": 3
    }
  ]
}
```

---

### **測試案例 3：滿千免運**

#### **前置條件**
```http
# 先加入高價商品到購物車，確保小計 >= 1000
POST https://localhost:7106/api/Carts/user/1/items
Content-Type: application/json

{
  "productId": 4,
  "attributeValueId": 10,
  "quantity": 3
}
```

#### **API 端點**
```http
GET https://localhost:7106/api/Checkout/delivery-methods/1
```

#### **預期結果**
```json
{
  "success": true,
  "data": [
    {
      "method": "HOME_TCAT",
      "name": "黑貓宅急便",
      "fee": 0,  // ← 滿千免運
      "description": "黑貓宅急便到府配送 - 1-2個工作天 (滿千免運)",
      "isAvailable": true,
      "estimatedDays": 2
    }
  ]
}
```

---

### **測試案例 4：運費計算 API**

#### **測試各種配送方式的運費**

```http
# 黑貓宅急便
GET https://localhost:7106/api/Checkout/shipping-fee/1?deliveryMethod=HOME_TCAT
# 預期：65

# 7-11 超商取貨
GET https://localhost:7106/api/Checkout/shipping-fee/1?deliveryMethod=UNIMART
# 預期：60

# 全家便利商店
GET https://localhost:7106/api/Checkout/shipping-fee/1?deliveryMethod=FAMI
# 預期：60
```

---

### **測試案例 5：離島地區限制**

#### **前置條件**
```sql
-- 新增離島地址
INSERT INTO MemberAddresses (MembersId, RecipientName, PhoneNumber, City, District, StreetAddress, IsDefault, CreatedAt, UpdatedAt)
VALUES (1, '測試用戶', '0912345678', '澎湖縣', '馬公市', '測試路123號', 0, GETDATE(), GETDATE());

-- 取得地址ID
SELECT Id FROM MemberAddresses WHERE City = '澎湖縣' AND MembersId = 1;
```

#### **API 端點**
```http
GET https://localhost:7106/api/Checkout/delivery-methods/1?addressId={剛插入的地址ID}
```

#### **預期結果**
```json
{
  "success": true,
  "data": [
    {
      "method": "HOME_TCAT",
      "name": "黑貓宅急便",
      "fee": 165,  // ← 原65元 + 離島加收100元
      "description": "黑貓宅急便到府配送 - 1-2個工作天 (離島地區加收100元)",
      "isAvailable": true,
      "estimatedDays": 3  // ← 配送時間延長
    }
    // 注意：超商取貨選項被移除，因為不送離島
  ]
}
```

---

## 🚀 **完整結帳流程測試**

### **使用綠界物流代碼建立訂單**

```http
POST https://localhost:7106/api/Checkout/create-order
Content-Type: application/json

{
  "memberId": 1,
  "recipientName": "測試用戶",
  "phoneNumber": "0912345678",
  "city": "台北市",
  "district": "中正區",
  "addressDetail": "測試地址123號",
  "deliveryMethod": "HOME_TCAT",  // ← 使用綠界代碼
  "paymentMethod": "credit_card",
  "couponCode": "",
  "usedPoints": 0,
  "note": "測試訂單"
}
```

### **驗證訂單中的配送方式**
```http
GET https://localhost:7106/api/Checkout/order-confirmation?orderId={orderId}&memberId=1
```

預期 `deliveryMethod` 欄位為 `"HOME_TCAT"`

---

## 📊 **綠界物流代碼對照表**

| **物流商名稱** | **資料庫 Carrier.Name** | **綠界代碼 (Method)** | **運費** | **說明** |
|---------------|----------------------|-------------------|---------|---------|
| 黑貓宅急便 | 黑貓宅急便 | `HOME_TCAT` | 65元 | 宅配到府 |
| 7-11超商取貨 | 7-11 超商取貨 | `UNIMART` | 60元 | 超商取貨付款 |
| 全家便利商店 | 全家便利商店 | `FAMI` | 60元 | 超商取貨付款 |

---

## 🎯 **測試檢查清單**

| **測試項目** | **狀態** | **備註** |
|-------------|---------|---------|
| ⬜ 基本物流選項從資料庫讀取 | | 3個選項，使用綠界代碼 |
| ⬜ 金牌會員運費優惠 | | 各運費 -20元 |
| ⬜ 滿千免運計算 | | 購物車 >= 1000 時運費為0 |
| ⬜ 運費計算API正確 | | 各配送方式運費對應 |
| ⬜ 離島地區限制 | | 超商不可選，宅配+100元 |
| ⬜ 訂單建立使用綠界代碼 | | deliveryMethod 正確儲存 |

---

## 🔮 **下一步：Team.Backend 管理員物流管理**

當 Team.API 的配送功能測試完成後，我們可以在 Team.Backend 建立：

1. **AdminLogisticsController** - 管理員物流管理控制器
2. **物流商管理頁面** - 新增/編輯/停用物流商
3. **運費設定頁面** - 配置各地區運費規則
4. **物流統計報表** - 各物流商使用統計

**先完成 Team.API 的測試，確保配送功能穩定！** 🎉